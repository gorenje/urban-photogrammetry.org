var MapAnimation = {
  emptyAnim: {
    pause: function(){},
    play: function(){}
  },

  ViewModelFrame: {
    examine: "Current Model"
  }
};

MapAnimation = {...MapAnimation, ...{
  keyFrames: [
    {"zoom":17.564263978867494,"position_latitude":52.52503415310028,"position_longitude":13.421729076654637,"tilt":43.787405574659225,"rotation":-138.04825027720412},
    {"zoom":17.575728718459676,"position_latitude":52.52201323000966,"position_longitude":13.409346258721442,"tilt":19.799651222693385,"rotation":11.402182219878714},
    {"zoom":17.79999999999999,"position_latitude":52.520634612119515,"position_longitude":13.408208494688466,"tilt":39.02617544016254,"rotation":-108.84836358895853},
{"zoom":17.79999999999999,"position_latitude":52.5213523257361,"position_longitude":13.406104321599244,"tilt":43.937995327592226,"rotation":-129.09836358895853},
    {"zoom":17.79999999999999,"position_latitude":52.51758943154345,"position_longitude":13.397918988654963,"tilt":24.70265324794164,"rotation":-154.81431689635122},
    {"zoom":17.9312481536,"position_latitude":52.516605341692376,"position_longitude":13.397216128811124,"tilt":0,"rotation":13.3936508358626},

    MapAnimation.ViewModelFrame, // schinkel klause

    {"zoom":18,"position_latitude":52.51878925498369,"position_longitude":13.403132600849403,"tilt":0,"rotation":21.07874035255887},
    {"zoom":18,"position_latitude":52.51849411964798,"position_longitude":13.402997969815498,"tilt":0,"rotation":207.87095586241188},
    MapAnimation.ViewModelFrame, // engels

    {"zoom":17.6,"position_latitude":52.52036192322607,"position_longitude":13.397809574273278,"tilt":19.133558748943454,"rotation":206.1900220102718},
    {"zoom":18,"position_latitude":52.52022386246821,"position_longitude":13.397989555149719,"tilt":19.133558748943454,"rotation":206.1900220102718},
    {"zoom":18,"position_latitude":52.5198847469784,"position_longitude":13.397286788602456,"tilt":0,"rotation":220.78886118601991},
    MapAnimation.ViewModelFrame, // amazonia

    {"zoom":16.000000000000007,"position_latitude":52.52159014784615,"position_longitude":13.396502498372456,"tilt":19.133558748943454,"rotation":206.1900220102718},
    {"zoom":18,"position_latitude":52.52783253339743,"position_longitude":13.39858662276589,"tilt":19.133558748943454,"rotation":206.1900220102718},
    {"zoom":17.75550303378801,"position_latitude":52.52865823341268,"position_longitude":13.399404343193277,"tilt":0,"rotation":43.41959399470783},
    MapAnimation.ViewModelFrame, // clowns

    {"zoom":15.600000000000009,"position_latitude":52.517071135122045,"position_longitude":13.367763211560106,"tilt":19.133558748943454,"rotation":206.1900220102718},
    {"zoom":18,"position_latitude":52.51960630652334,"position_longitude":13.368986561298458,"tilt":19.133558748943454,"rotation":206.1900220102718},
    {"zoom":18,"position_latitude":52.51872502573343,"position_longitude":13.368824820485363,"tilt":0,"rotation":206.7503332943185},
    MapAnimation.ViewModelFrame, // rotersandstein

    {"zoom":18,"position_latitude":52.51397646799167,"position_longitude":13.368792958212051,"tilt":19.133558748943454,"rotation":206.1900220102718},
    {"zoom":18,"position_latitude":52.513981643959696,"position_longitude":13.368361769217168,"tilt":0,"rotation":206.1900220102718},
    {"zoom":18,"position_latitude":52.51467244254556,"position_longitude":13.367463489551078,"tilt":2.1497608258290235,"rotation":303.96359728535145},
    MapAnimation.ViewModelFrame, // hirsch

    {"zoom":18,"position_latitude":52.507666572855214,"position_longitude":13.365848697600084,"tilt":12.590870667793833,"rotation":205.13352898019113},
    {"zoom":18,"position_latitude":52.507641436922064,"position_longitude":13.366040262203605,"tilt":0,"rotation":206.18984042065549},
    MapAnimation.ViewModelFrame, // janus 2

    {"zoom":18,"position_latitude":52.507567666135095,"position_longitude":13.362337183393484,"tilt":12.590870667793833,"rotation":205.13352898019113},
    {"zoom":15.600000000000009,"position_latitude":52.507567666135095,"position_longitude":13.362337183393484,"tilt":12.590870667793833,"rotation":205.13352898019113},
    {"zoom":15.600000000000009,"position_latitude":52.54046778346811,"position_longitude":13.378807178013023,"tilt":12.590870667793833,"rotation":205.13352898019113},
    {"zoom":16.199999999999996,"position_latitude":52.535904085410046,"position_longitude":13.374351176086716,"tilt":55.68460518363935,"rotation":-5.337236467232307},
    {"zoom":18,"position_latitude":52.53775770525703,"position_longitude":13.377584785752653,"tilt":12.590870667793833,"rotation":205.13352898019113},
    {"zoom":18,"position_latitude":52.53854603161615,"position_longitude":13.3786339448949,"tilt":0,"rotation":166.47205038096948},
    MapAnimation.ViewModelFrame, // engel - friedhof

    {"zoom":18,"position_latitude":52.53829474754796,"position_longitude":13.37836500057179,"tilt":16.851225697379626,"rotation":126.95304475421891},
    {"zoom":16.400000000000006,"position_latitude":52.53742584505776,"position_longitude":13.391551545400642,"tilt":16.851225697379626,"rotation":126.95304475421891},
    {"zoom":16.400000000000006,"position_latitude":52.53132049445016,"position_longitude":13.413052585610954,"tilt":16.851225697379626,"rotation":126.95304475421891},
    {"zoom":18,"position_latitude":52.5313501316639,"position_longitude":13.413669603850906,"tilt":16.851225697379626,"rotation":126.95304475421891},
    {"zoom":18,"position_latitude":52.532975580572845,"position_longitude":13.413062209249548,"tilt":21.72020287404909,"rotation":21.039618488628218},
    {"zoom":18,"position_latitude":52.53212419902776,"position_longitude":13.412687859562643,"tilt":0,"rotation":32.51728351000222},
    MapAnimation.ViewModelFrame, // senefelder

    {"zoom":16.400000000000006,"position_latitude":52.5246759471983,"position_longitude":13.411054784728822,"tilt":21.72020287404909,"rotation":21.039618488628218},
    {"zoom":18,"position_latitude":52.526790765120225,"position_longitude":13.411860072035836,"tilt":8.634826711749868,"rotation":20.24724871606769},
    {"zoom":18,"position_latitude":52.52713531578863,"position_longitude":13.413925584751011,"tilt":0,"rotation":-41.94730381311514},
    MapAnimation.ViewModelFrame, // rosa luxemburg

    {"zoom":18,"position_latitude":52.52926587817333,"position_longitude":13.421420370349058,"tilt":8.634826711749868,"rotation":20.24724871606769},
    {"zoom":18,"position_latitude":52.52925248345829,"position_longitude":13.421054293694445,"tilt":27.19780219780224,"rotation":-182.59941305942772},
    {"zoom":16.400000000000006,"position_latitude":52.52790781433654,"position_longitude":13.430399974921865,"tilt":27.19780219780224,"rotation":-182.59941305942772},
    {"zoom":17.400000000000002,"position_latitude":52.52584770108563,"position_longitude":13.430422834955356,"tilt":27.19780219780224,"rotation":-182.59941305942772},
    {"zoom":17.400000000000002,"position_latitude":52.52607693487538,"position_longitude":13.429835319271255,"tilt":42,"rotation":-331.4583087649501},
    {"zoom":17.400000000000002,"position_latitude":52.525813725479736,"position_longitude":13.431416525259271,"tilt":0,"rotation":-318.57114923187595},
    MapAnimation.ViewModelFrame, // spainische krieger denkmal

    {"zoom":16.400000000000006,"position_latitude":52.53383128658737,"position_longitude":13.431433225126248,"tilt":42,"rotation":-344.70984250728117},
    {"zoom":17.200000000000003,"position_latitude":52.53939469766116,"position_longitude":13.43410633924266,"tilt":42,"rotation":-344.70984250728117},
    {"zoom":18,"position_latitude":52.53833114096901,"position_longitude":13.432969770476225,"tilt":42,"rotation":-54.501253550226295},
    {"zoom":18,"position_latitude":52.5381851436698,"position_longitude":13.43343240926975,"tilt":0,"rotation":-57.30280997045976},
    MapAnimation.ViewModelFrame, // ernst thaelmann

    {"zoom":17.6,"position_latitude":52.53862645142186,"position_longitude":13.426624640446189,"tilt":43.96253602305475,"rotation":17.940464241184763},
    {"zoom":18,"position_latitude":52.54050572752514,"position_longitude":13.428048775594958,"tilt":41.96253602305475,"rotation":17.940464241184763},
    {"zoom":15.800000000000008,"position_latitude":52.56913380160043,"position_longitude":13.444883040641702,"tilt":41.96253602305475,"rotation":17.940464241184763},
    {"zoom":18,"position_latitude":52.57024470438567,"position_longitude":13.446422278491994,"tilt":41.96253602305475,"rotation":17.940464241184763},
    {"zoom":17.1559271546841,"position_latitude":52.56968583253286,"position_longitude":13.445750871722785,"tilt":64.8536613661472,"rotation":17.660308599161418},
    {"zoom":18,"position_latitude":52.56900237887969,"position_longitude":13.445535257467034,"tilt":22.521613832852978,"rotation":-110.5994130594287},
    {"zoom":18,"position_latitude":52.569218516339504,"position_longitude":13.445453494706767,"tilt":0,"rotation":-109.75894613335865},
    MapAnimation.ViewModelFrame, // buddhist temple

    {"zoom":15,"position_latitude":52.56900237887969,"position_longitude":13.445535257467034,"tilt":22.521613832852978,"rotation":-110.5994130594287},
    {"zoom":15,"position_latitude":52.569144317413404,"position_longitude":13.39350647446221,"tilt":22.521613832852978,"rotation":-110.5994130594287},
    {"zoom":17.59999999999999,"position_latitude":52.56981876935501,"position_longitude":13.393942801841346,"tilt":22.521613832852978,"rotation":-110.5994130594287},
    {"zoom":18,"position_latitude":52.5694284239636,"position_longitude":13.39381900396173,"tilt":0,"rotation":30.318874878314517},
    MapAnimation.ViewModelFrame, // pankow buerger park

    {"zoom":15.999999999999996,"position_latitude":52.56981876935501,"position_longitude":13.393942801841346,"tilt":22.521613832852978,"rotation":-110.5994130594287},
    {"zoom":17.59999999999999,"position_latitude":52.57168891211305,"position_longitude":13.386199568519876,"tilt":22.521613832852978,"rotation":-110.5994130594287},
    {"zoom":15,"position_latitude":52.50827405347126,"position_longitude":13.279230307661816,"tilt":42,"rotation":-272.7098425072809},
    {"zoom":15,"position_latitude":52.50075194713044,"position_longitude":13.300630881970854,"tilt":56.98627630375114,"rotation":-282.0534231246126},
    {"zoom":18,"position_latitude":52.507198628666764,"position_longitude":13.286118650911469,"tilt":21.82997118155617,"rotation":-275.36014925574733},
    {"zoom":18,"position_latitude":52.50722677642856,"position_longitude":13.2865878032603,"tilt":0,"rotation":-273.6792154036072},
    MapAnimation.ViewModelFrame, // seals in charlottenburg

    {"zoom":15,"position_latitude":52.51833524264239,"position_longitude":13.31574435842597,"tilt":0,"rotation":-273.6792154036072},
    {"zoom":15,"position_latitude":52.527901512777596,"position_longitude":13.368676578254043,"tilt":0,"rotation":-273.6792154036072},
    {"zoom":15,"position_latitude":52.53138907312063,"position_longitude":13.408081278042259,"tilt":0,"rotation":-273.6792154036072},
    {"zoom":18,"position_latitude":52.53188950618247,"position_longitude":13.41003329415108,"tilt":0,"rotation":-273.6792154036072},
    {"zoom":18,"position_latitude":52.532016468090646,"position_longitude":13.409288535832369,"tilt":0,"rotation":-145.08777571489125},
    MapAnimation.ViewModelFrame, // froschkoenig
  ],

  animState: {
  },

  currKeyFrame: 0,
  currAnim: MapAnimation.emptyAnim,
  currTimeout: null,

  moveToShareData: function(sharedata) {
    MapAnimation.stateFromCamera()
    var startPos = L.latLng( MapAnimation.animState.position_latitude,
                             MapAnimation.animState.position_longitude )
    var endPos = null;
    var onAnimComplete = function() {}
    var toFrameData = {}

    if ( sharedata.t == 'e' ) {
      // this share data came from the model examiner, so we fly to that
      // position and then open the model examiner
      onAnimComplete = function() {
        setTimeout( function() {
          sharedata.model.autoExitAfterAnim = true
          MapHelper.examineModel( sharedata.model.mlid, {
            model_details: sharedata.model
          })
        }, 750)
      };

      endPos = L.latLng( sharedata.pos.loc[0], sharedata.pos.loc[1] )

      toFrameData = {
        tilt:               0,
        rotation:           90,
        position_latitude:  sharedata.pos.loc[0],
        position_longitude: sharedata.pos.loc[1],
        zoom:               18
      }
    }

    if ( sharedata.t == 'm' ) {
      // this share data came from the map, so we fly to the position given
      // in the shared data and do nothing further.
      onAnimComplete = function() {
        setTimeout( function() {
          $(MapHelper.AllButtons["butPause"]).hide()
          $(MapHelper.AllButtons["butPlay"]).show()
        }, 150)
      };

      endPos = L.latLng( sharedata.pos.lt, sharedata.pos.lg )

      toFrameData = {
        tilt:               sharedata.pos.tl,
        rotation:           sharedata.pos.r,
        position_latitude:  sharedata.pos.lt,
        position_longitude: sharedata.pos.lg,
        zoom:               sharedata.pos.zm
      }
    }

    if ( endPos != null ) {
      var duration = Math.max(1500, endPos.distanceTo(startPos) / 0.25)
      setTimeout( function() {
        $(window).trigger("infoscreen:hide", { frameNr: 2 } )
      }, duration / 2)

      MapAnimation.currAnim = anime({
        targets:  MapAnimation.animState,
        easing:   'cubicBezier(.62,.28,.56,.88)',
        duration: duration,
        update:   MapAnimation.animUpdateCallback,
        complete: onAnimComplete,
        ...toFrameData
      })
      return true;
    }
    return false;
  },

  stateFromCamera: function() {
    MapAnimation.animState = {
      tilt:               map.getTilt(),
      rotation:           map.getRotation(),
      position_latitude:  map.getPosition().latitude,
      position_longitude: map.getPosition().longitude,
      zoom:               map.getZoom()
    }
  },

  animUpdateCallback: function() {
    map.setTilt( MapAnimation.animState.tilt )
    map.setRotation( MapAnimation.animState.rotation )
    map.setPosition( {
      latitude:  MapAnimation.animState.position_latitude,
      longitude: MapAnimation.animState.position_longitude
    })
    map.setZoom( MapAnimation.animState.zoom )
  },

  animCompleteCallback: function(anim) {
    MapAnimation.currAnim = MapAnimation.emptyAnim

    MapAnimation.currTimeout = setTimeout(function() {
      MapAnimation.nextKeyFrame()
    }, 600 );
  },

  moveToPos: function(pos) {
    MapAnimation.stateFromCamera()
    var startPos = L.latLng( MapAnimation.animState.position_latitude,
                             MapAnimation.animState.position_longitude )
    var endPos = L.latLng( pos.position_latitude, pos.position_longitude )

    MapAnimation.currAnim = anime({
      targets:  MapAnimation.animState,
      easing:   'cubicBezier(.62,.28,.56,.88)',
      duration: Math.max(1500,startPos.distanceTo(endPos) / 0.25),
      update:   MapAnimation.animUpdateCallback,
      complete: function() { $(window).trigger("movetopos:complete") },
      ...pos
    })
  },

  moveToFrame: function(frameNr) {
    var startPos = L.latLng( MapAnimation.animState.position_latitude,
                             MapAnimation.animState.position_longitude )
    var endPos = L.latLng( MapAnimation.keyFrames[frameNr].position_latitude,
                           MapAnimation.keyFrames[frameNr].position_longitude )

    $(window).trigger("keyframe:moveto", { frameNr: frameNr } )

    MapAnimation.currAnim = anime({
      targets:  MapAnimation.animState,
      easing:   'cubicBezier(.62,.28,.56,.88)',
      duration: Math.max(1500,startPos.distanceTo(endPos) / 0.25),
      update:   MapAnimation.animUpdateCallback,
      complete: MapAnimation.animCompleteCallback,
      ...MapAnimation.keyFrames[frameNr]
    })
  },

  nextKeyFrame: function() {
    MapAnimation.currKeyFrame += 1

    if ( MapAnimation.keyFrames[MapAnimation.currKeyFrame] == undefined ) {
      return;
    }

    if (MapAnimation.keyFrames[MapAnimation.currKeyFrame] == MapAnimation.ViewModelFrame){
      MapAnimation.currKeyFrame += 1
      MapHelper.examineModel( MapHelper.currentVisibleModels()[0].mlid, {
        callback: function() {
          setTimeout(function() {
            ButtonHelpers.CB.flythrough( { autoExitAfterFlythrough: true } )
          }, 1000)
        }
      })
    } else {
      // console.log( "Next frame: " + MapAnimation.currKeyFrame)
      // console.log( MapAnimation.keyFrames[MapAnimation.currKeyFrame] )
      MapAnimation.moveToFrame(MapAnimation.currKeyFrame)
    }
  },

  stop: function() {
    clearTimeout( MapAnimation.currTimeout )
    MapAnimation.currAnim.pause()
    MapAnimation.currKeyFrame = 0;
  },

  pause: function() {
    clearTimeout( MapAnimation.currTimeout )
    MapAnimation.currAnim.pause()
  },

  play: function() {
    if (MapAnimation.currKeyFrame < MapAnimation.keyFrames.length ) {
      MapAnimation.stateFromCamera()
      MapAnimation.moveToFrame(MapAnimation.currKeyFrame)
    } else {
      $(MapHelper.AllButtons["butPause"]).hide()
      $(MapHelper.AllButtons["butPlay"]).show()
      MapAnimation.currKeyFrame = 0
    }
  },

  start: function(fromFrame = 0) {
    MapAnimation.currKeyFrame = fromFrame;
    MapAnimation.animState = {
      ...MapAnimation.keyFrames[MapAnimation.currKeyFrame]
    }

    MapAnimation.currKeyFrame += 1
    MapAnimation.moveToFrame(MapAnimation.currKeyFrame)
  },

}};
